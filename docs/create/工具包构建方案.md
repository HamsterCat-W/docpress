#### 为工具包接入构建方案

##### 前端开发过程中存在的主流的模块格式：CommonJs、ESM

众所周知，在 ESM 中引入 mjs,在 cjs 中引入 cjs 是可行的，但是如果在 esm 中引入 cjs 和在 cjs 中引入 mjs 会发生什么呢？

如 test 文件夹下创建了四个文件：util.cjs、util.mjs、add.mjs、add.cjs

两个 util 文件中分别存储了各自的 add 函数数，分别在两个 add 文件中引入

通过在 test 目录下分别执行 node add.mjs 和 node add.cjs 可以发现，在 esm 中引入 cjs 是可行的，但是在 cjs 中去引入 mjs 会报错

原因是：cjs 采用同步加载的方式去引入，而 esm 采用 import 异步引入的方式

如果想要在 cjs 中引入 mjs，则需要提供一个异步的环境

```js
// 异步环境下
async function foo() {
  const { add } = await import("./util.mjs");
  let res = add(1, 2);
  console.log("🚀 ~ file: add.cjs:11 ~ foo ~ res:", res);
}

foo();
```

为了保证兼容性，最好同时产出 esm 和 cjs 两种格式的产物

##### 库构建工具 tsup

docs:
https://paka.dev/npm/tsup@6.6.3/api#100aa345d24dd1cc

安装：

```bash
pnpm i tsup -D
```

tsup 配置文件
tsup.config.ts

```ts
import { defineConfig } from "tsup";

export default defineConfig({
  entry: ["src/node/cli.ts"],
  // 开启bundle模式
  bundle: true,
  outDir: "dist",
  splitting: true,
  format: ["cjs", "esm"],
  dts: true,
  shims: true,
  clean: true,
  // // 使用它可以在生成的 JavaScript 和 CSS 文件的开头插入任意字符串。这样就解决了 throw new Error('Dynamic require of "' + x + '" is not supported');报错问题
  banner: {
    js: 'import { createRequire as createRequire0 } from "module"; const require = createRequire0(import.meta.url);',
  },
});
```

更改 tsc 的编译方式为 tsup
package.json

```json
"scripts": {
    "start": "tsup --watch",
    "build":"tsup"
  },
```

在 bin 目录下引入 esm 格式的构建产物

```js
#!/usr/bin/env node
// nodejs 中cli 入口必须要加这行代码是个约定，否则提示语法错误
import("../dist/cli.mjs");
```
