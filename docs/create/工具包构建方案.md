#### ä¸ºå·¥å…·åŒ…æ¥å…¥æ„å»ºæ–¹æ¡ˆ

##### å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­å­˜åœ¨çš„ä¸»æµçš„æ¨¡å—æ ¼å¼ï¼šCommonJsã€ESM

ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ ESM ä¸­å¼•å…¥ mjs,åœ¨ cjs ä¸­å¼•å…¥ cjs æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœåœ¨ esm ä¸­å¼•å…¥ cjs å’Œåœ¨ cjs ä¸­å¼•å…¥ mjs ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

å¦‚ test æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºäº†å››ä¸ªæ–‡ä»¶ï¼šutil.cjsã€util.mjsã€add.mjsã€add.cjs

ä¸¤ä¸ª util æ–‡ä»¶ä¸­åˆ†åˆ«å­˜å‚¨äº†å„è‡ªçš„ add å‡½æ•°æ•°ï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ª add æ–‡ä»¶ä¸­å¼•å…¥

é€šè¿‡åœ¨ test ç›®å½•ä¸‹åˆ†åˆ«æ‰§è¡Œ node add.mjs å’Œ node add.cjs å¯ä»¥å‘ç°ï¼Œåœ¨ esm ä¸­å¼•å…¥ cjs æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯åœ¨ cjs ä¸­å»å¼•å…¥ mjs ä¼šæŠ¥é”™

åŸå› æ˜¯ï¼šcjs é‡‡ç”¨åŒæ­¥åŠ è½½çš„æ–¹å¼å»å¼•å…¥ï¼Œè€Œ esm é‡‡ç”¨ import å¼‚æ­¥å¼•å…¥çš„æ–¹å¼

å¦‚æœæƒ³è¦åœ¨ cjs ä¸­å¼•å…¥ mjsï¼Œåˆ™éœ€è¦æä¾›ä¸€ä¸ªå¼‚æ­¥çš„ç¯å¢ƒ

```js
// å¼‚æ­¥ç¯å¢ƒä¸‹
async function foo() {
  const { add } = await import("./util.mjs");
  let res = add(1, 2);
  console.log("ğŸš€ ~ file: add.cjs:11 ~ foo ~ res:", res);
}

foo();
```

ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼Œæœ€å¥½åŒæ—¶äº§å‡º esm å’Œ cjs ä¸¤ç§æ ¼å¼çš„äº§ç‰©

##### åº“æ„å»ºå·¥å…· tsup

docs:
https://paka.dev/npm/tsup@6.6.3/api#100aa345d24dd1cc

å®‰è£…ï¼š

```bash
pnpm i tsup -D
```

tsup é…ç½®æ–‡ä»¶
tsup.config.ts

```ts
import { defineConfig } from "tsup";

export default defineConfig({
  entry: ["src/node/cli.ts"],
  // å¼€å¯bundleæ¨¡å¼
  bundle: true,
  outDir: "dist",
  splitting: true,
  format: ["cjs", "esm"],
  dts: true,
  shims: true,
  clean: true,
  // // ä½¿ç”¨å®ƒå¯ä»¥åœ¨ç”Ÿæˆçš„ JavaScript å’Œ CSS æ–‡ä»¶çš„å¼€å¤´æ’å…¥ä»»æ„å­—ç¬¦ä¸²ã€‚è¿™æ ·å°±è§£å†³äº† throw new Error('Dynamic require of "' + x + '" is not supported');æŠ¥é”™é—®é¢˜
  banner: {
    js: 'import { createRequire as createRequire0 } from "module"; const require = createRequire0(import.meta.url);',
  },
});
```

æ›´æ”¹ tsc çš„ç¼–è¯‘æ–¹å¼ä¸º tsup
package.json

```json
"scripts": {
    "start": "tsup --watch",
    "build":"tsup"
  },
```

åœ¨ bin ç›®å½•ä¸‹å¼•å…¥ esm æ ¼å¼çš„æ„å»ºäº§ç‰©

```js
#!/usr/bin/env node
// nodejs ä¸­cli å…¥å£å¿…é¡»è¦åŠ è¿™è¡Œä»£ç æ˜¯ä¸ªçº¦å®šï¼Œå¦åˆ™æç¤ºè¯­æ³•é”™è¯¯
import("../dist/cli.mjs");
```
